<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>Âè∞Âåó YouBike Âç≥ÊôÇÂú∞Âúñ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#map {
  width: 100%;
  height: 100%;
}

/* ===== ‰∏äÊñπ UI ===== */
.top-left {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 1000;
  background: #fff;
  padding: 6px 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.2);
  font-size: 14px;
}

.top-center {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: flex;
  gap: 8px;
}

.top-center input,
.top-center select {
  padding: 8px 12px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

/* ===== Ê∞¥Êª¥ Marker ===== */
.yb-marker {
  position: relative;
  width: 46px;
  height: 46px;
  border-radius: 50% 50% 50% 0;
  transform: rotate(-45deg);
  border: 2px solid #fff;
  box-shadow: 0 0 4px rgba(0,0,0,.4);
}

.yb-marker.green  { background: #7AC943; }
.yb-marker.yellow { background: #F5A623; }
.yb-marker.red    { background: #A80000; }

.yb-inner {
  position: absolute;
  top: 6px;
  left: 6px;
  width: 34px;
  height: 34px;
  transform: rotate(45deg);
  color: #fff;
  font-weight: bold;
  font-size: 13px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.yb-line {
  width: 18px;
  height: 2px;
  background: rgba(255,255,255,.8);
  margin: 2px 0;
}
</style>
</head>

<body>

<div class="top-left" id="count">Á´ôÈªûÔºö-- Á≠Ü</div>

<div class="top-center">
  <input id="search" placeholder="ÊêúÂ∞ãÁ´ôÈªûÂêçÁ®±‚Ä¶" />
  <select id="filter">
    <option value="all">ÂÖ®ÈÉ®</option>
    <option value="green">Ê≠£Â∏∏</option>
    <option value="yellow">ÁÑ°Ëªä</option>
    <option value="red">ÁÑ°‰Ωç</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API =
  "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";

/* Âú∞Âúñ */
const map = L.map("map").setView([25.04, 121.53], 13);
map.zoomControl.setPosition("topright");

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap",
}).addTo(map);

let markers = [];
let rawData = [];

/* ÁãÄÊÖãÂà§Êñ∑ */
function getStatus(borrow, ret) {
  if (ret === 0) return "red";
  if (borrow === 0) return "yellow";
  return "green";
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function render(list) {
  clearMarkers();

  list.forEach(s => {
    const lat = Number(s.latitude);
    const lng = Number(s.longitude);
    const borrow = Number(s.available_rent_bikes);
    const ret = Number(s.available_return_bikes);

    if ([lat, lng, borrow, ret].some(n => Number.isNaN(n))) return;

    const status = getStatus(borrow, ret);

    const icon = L.divIcon({
      className: "",
      iconSize: [46, 46],
      iconAnchor: [23, 46],
      html: `
        <div class="yb-marker ${status}">
          <div class="yb-inner">
            <div>${borrow}</div>
            <div class="yb-line"></div>
            <div>${ret}</div>
          </div>
        </div>
      `
    });

    const marker = L.marker([lat, lng], { icon })
      .addTo(map)
      .bindPopup(`
        <b>${s.sna}</b><br>
        üö≤ ÂèØÂÄüÔºö${borrow}<br>
        üÖøÔ∏è ÂèØÈÇÑÔºö${ret}
      `);

    markers.push(marker);
  });

  document.getElementById("count").textContent =
    `Á´ôÈªûÔºö${markers.length} Á≠Ü`;
}

function applyFilter() {
  const kw = search.value.trim();
  const f = filter.value;

  render(
    rawData.filter(s => {
      const borrow = Number(s.available_rent_bikes);
      const ret = Number(s.available_return_bikes);
      const status = getStatus(borrow, ret);

      if (kw && !s.sna.includes(kw)) return false;
      if (f !== "all" && status !== f) return false;
      return true;
    })
  );
}

search.addEventListener("input", applyFilter);
filter.addEventListener("change", applyFilter);

/* ËºâÂÖ•Ë≥áÊñô */
async function load() {
  const res = await fetch(API, { cache: "no-store" });
  rawData = await res.json();
  applyFilter();
}

load();
setInterval(load, 30000);
</script>

</body>
</html>
