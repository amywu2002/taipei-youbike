<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å°åŒ— YouBike å³æ™‚åœ°åœ–</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }

    #topbar {
      padding: 8px 12px;
      background: #fff;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    #search {
      padding: 6px 8px;
      font-size: 14px;
      width: 220px;
    }

    #updated {
      font-size: 13px;
      color: #555;
    }

    #map {
      height: calc(100vh - 46px);
      width: 100%;
    }

    .circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      color: #fff;
      font-size: 12px;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 2px solid #fff;
      box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }

    .circle .line {
      width: 60%;
      height: 1px;
      background: rgba(255,255,255,0.9);
      margin: 2px 0;
    }

    .green { background: #2ecc71; }
    .yellow { background: #f1c40f; }
    .red { background: #e74c3c; }
  </style>
</head>
<body>

<div id="topbar">
  <input id="search" placeholder="æœå°‹ç«™åâ€¦" />
  <span id="updated">è¼‰å…¥ä¸­â€¦</span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API =
  "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";

const map = L.map("map").setView([25.0375, 121.5637], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let markers = [];
let stations = [];

function getColor(bike, space) {
  if (bike === 0) return "yellow";
  if (space === 0) return "red";
  return "green";
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function render(keyword = "") {
  clearMarkers();

  stations
    .filter(s => s.name.includes(keyword))
    .forEach(s => {
      const color = getColor(s.available, s.empty);

      const icon = L.divIcon({
        className: "",
        iconSize: [42, 42],
        iconAnchor: [21, 21],
        html: `
          <div class="circle ${color}">
            <div>${s.available}</div>
            <div class="line"></div>
            <div>${s.empty}</div>
          </div>
        `
      });

      const marker = L.marker([s.lat, s.lng], { icon }).addTo(map);

      marker.bindPopup(`
        <b>${s.name}</b><br>
        ğŸš² å¯å€Ÿï¼š${s.available}<br>
        ğŸ…¿ï¸ å¯é‚„ï¼š${s.empty}<br>
        ğŸ”¢ ç¸½è»ŠæŸ±ï¼š${s.total}
      `);

      markers.push(marker);
    });
}

async function loadData() {
  try {
    const res = await fetch(API);
    const data = await res.json();

    stations = data
      .filter(d =>
        d.isact === "1" &&
        !isNaN(Number(d.lat)) &&
        !isNaN(Number(d.lng))
      )
      .map(d => ({
        name: d.sna.replace("YouBike2.0_", ""),
        lat: Number(d.lat),
        lng: Number(d.lng),
        available: Number(d.sbi),
        empty: Number(d.bemp),
        total: Number(d.tot)
      }));

    render(document.getElementById("search").value);

    document.getElementById("updated").textContent =
      "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString();
  } catch (e) {
    document.getElementById("updated").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—";
    console.error(e);
  }
}

document.getElementById("search").addEventListener("input", e => {
  render(e.target.value);
});

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>

