<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å°åŒ— YouBike å³æ™‚åœ°åœ–</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }

    #topbar {
      padding: 10px;
      background: #f7f7f7;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #search {
      padding: 6px 10px;
      font-size: 14px;
      width: 220px;
    }

    #updated {
      font-size: 13px;
      color: #555;
    }

    #map {
      height: calc(100vh - 50px);
      width: 100%;
    }

    /* åœ“å½¢åœ–ç¤º */
    .circle {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      color: white;
      font-size: 13px;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .circle .line {
      width: 70%;
      height: 2px;
      background: white;
      margin: 2px 0;
    }

    .green { background: #2ecc71; }
    .yellow { background: #f1c40f; }
    .red { background: #e74c3c; }
  </style>
</head>
<body>

<div id="topbar">
  <input id="search" placeholder="æœå°‹ç«™åâ€¦" />
  <span id="updated">è¼‰å…¥ä¸­â€¦</span>
</div>

<div id="map"></div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ========= åŸºæœ¬è¨­å®š ========= */

const API =
  "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";

const map = L.map("map").setView([25.04, 121.53], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let markers = [];
let stations = [];

/* ========= å·¥å…· ========= */

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function isValidLatLng(lat, lng) {
  return (
    typeof lat === "number" &&
    typeof lng === "number" &&
    !isNaN(lat) &&
    !isNaN(lng)
  );
}

function getColor(available, empty) {
  if (available === 0) return "yellow";
  if (empty === 0) return "red";
  return "green";
}

/* ========= è³‡æ–™è¼‰å…¥ ========= */

async function loadData() {
  try {
    const res = await fetch(API);
    const raw = await res.json();

    stations = raw
      .filter(d => d.isact === "1")
      .map(d => {
        const lat = parseFloat(d.lat);
        const lng = parseFloat(d.lng);

        return {
          name: d.sna.replace("YouBike2.0_", ""),
          lat,
          lng,
          available: Number(d.sbi),
          empty: Number(d.bemp),
          total: Number(d.tot)
        };
      })
      // â­ é—œéµé˜²å‘†ï¼šå®Œå…¨é˜»æ“‹ NaN
      .filter(s => isValidLatLng(s.lat, s.lng));

    render(document.getElementById("search").value);

    document.getElementById("updated").textContent =
      "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString();

  } catch (err) {
    console.error(err);
    document.getElementById("updated").textContent = "è³‡æ–™è¼‰å…¥å¤±æ•—";
  }
}

/* ========= åœ°åœ–æ¸²æŸ“ ========= */

function render(keyword = "") {
  clearMarkers();

  stations
    .filter(s => s.name.includes(keyword))
    .forEach(s => {
      const color = getColor(s.available, s.empty);

      const icon = L.divIcon({
        className: "",
        iconSize: [42, 42],
        iconAnchor: [21, 21],
        html: `
          <div class="circle ${color}">
            <div>${s.available}</div>
            <div class="line"></div>
            <div>${s.empty}</div>
          </div>
        `
      });

      const marker = L.marker([s.lat, s.lng], { icon }).addTo(map);

      marker.bindPopup(`
        <b>${s.name}</b><br>
        ğŸš² å¯å€Ÿï¼š${s.available}<br>
        ğŸ…¿ï¸ å¯é‚„ï¼š${s.empty}<br>
        ğŸ”¢ ç¸½è»ŠæŸ±ï¼š${s.total}
      `);

      markers.push(marker);
    });
}

/* ========= äº‹ä»¶ ========= */

document.getElementById("search").addEventListener("input", e => {
  render(e.target.value);
});

/* ========= å•Ÿå‹• ========= */

loadData();
setInterval(loadData, 30000); // æ¯ 30 ç§’æ›´æ–°
</script>

</body>
</html>
