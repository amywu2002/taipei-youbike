<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>YouBike å³æ™‚åœ°åœ–ï¼ˆå°åŒ— / æ–°åŒ—ï¼‰</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#map {
  width: 100%;
  height: 100%;
}

/* ===== UIï¼ˆæ¡ƒåœ’ä¸€è‡´ï¼‰ ===== */
.top-left {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 1000;
  background: #fff;
  padding: 6px 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.25);
  font-size: 14px;
}

.top-center {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: flex;
  gap: 8px;
}

.top-center input,
.top-center select {
  padding: 8px 12px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

/* ===== å®˜æ–¹è‰² ===== */
.green  { --c:#7AC943; }
.yellow { --c:#F5A623; }
.red    { --c:#A80000; }

/* Leaflet icon èƒŒæ™¯ç§»é™¤ */
.leaflet-div-icon {
  background: transparent !important;
  border: none !important;
}
</style>
</head>

<body>

<div class="top-left">
  <span id="count">ç«™é»ï¼š--</span>
</div>

<div class="top-center">
  <select id="city">
    <option value="taipei">å°åŒ—</option>
    <option value="ntpc">æ–°åŒ—</option>
  </select>

  <input id="search" placeholder="æœå°‹å ´ç«™åç¨±æˆ–åœ°å€â€¦" />

  <select id="filter">
    <option value="all">å…¨éƒ¨</option>
    <option value="green">æ­£å¸¸</option>
    <option value="yellow">ç„¡è»Š</option>
    <option value="red">ç„¡ä½</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* API */
const API = {
  taipei: "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json",
  ntpc: "https://data.ntpc.gov.tw/api/datasets/71CD1490-A2DF-4198-BEF1-318479775E8A/json"
};

/* åœ°åœ– */
const map = L.map("map").setView([25.04, 121.53], 12);
map.zoomControl.setPosition("topright");

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap",
}).addTo(map);

let dataCache = [];
let markers = [];

/* é¡è‰²è¦å‰‡ */
function getColor(b, r) {
  if (r === 0) return "red";
  if (b === 0) return "yellow";
  return "green";
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

/* å®˜æ–¹æ°´æ»´ï¼ˆé–å®šï¼‰ */
function makeIcon(borrow, ret, color) {
  return L.divIcon({
    className: "",
    iconSize: [48, 60],
    iconAnchor: [24, 56],
    html: `
      <div class="${color}">
        <svg viewBox="0 0 64 72" width="55" height="60">
          <path
            d="M32 2 C20 2 10 12 10 26
               C10 44 32 68 32 68
               C32 68 54 44 54 26
               C54 12 44 2 32 2Z"
            fill="var(--c)"
            stroke="#fff"
            stroke-width="3"
          />
          <text x="32" y="22" text-anchor="middle"
            font-size="16" font-weight="700" fill="#fff">${borrow}</text>
          <line x1="20" y1="28" x2="44" y2="28"
            stroke="#fff" stroke-width="2" opacity="0.85"/>
          <text x="32" y="44" text-anchor="middle"
            font-size="16" font-weight="600" fill="#fff">${ret}</text>
        </svg>
      </div>`
  });
}

/* è½‰æˆçµ±ä¸€æ ¼å¼ */
function normalize(raw, city) {
  if (city === "taipei") {
    return raw.map(s => ({
      lat: s.latitude,
      lng: s.longitude,
      sna: s.sna,
      ar: s.ar,
      b: s.available_rent_bikes,
      r: s.available_return_bikes
    }));
  } else {
    return raw.map(s => ({
      lat: s.lat,
      lng: s.lng,
      sna: s.sna,
      ar: s.ar,
      b: s.sbi,
      r: s.bemp
    }));
  }
}

/* ç¯©é¸ + ç¹ªè£½ */
function applyFilter() {
  clearMarkers();

  const kw = search.value.trim();
  const f = filter.value;

  const list = dataCache.filter(s => {
    const st = getColor(s.b, s.r);

    if (kw && !s.sna.includes(kw) && !s.ar.includes(kw)) return false;
    if (f !== "all" && st !== f) return false;

    return true;
  });

  list.forEach(s => {
    const icon = makeIcon(s.b, s.r, getColor(s.b, s.r));
    const marker = L.marker([s.lat, s.lng], { icon })
      .addTo(map)
      .bindPopup(`
        <b>${s.sna}</b><br>
        ğŸ“ ${s.ar}<br>
        ğŸš² å¯å€Ÿï¼š${s.b}<br>
        ğŸ…¿ï¸ å¯é‚„ï¼š${s.r}
      `);
    markers.push(marker);
  });

  count.textContent = `ç«™é»ï¼š${markers.length} ç­†`;
}

/* è¼‰å…¥è³‡æ–™ */
async function loadData() {
  const city = document.getElementById("city").value;
  const res = await fetch(API[city], { cache: "no-store" });
  const raw = await res.json();
  dataCache = normalize(raw, city);
  applyFilter();
}

/* äº‹ä»¶ */
search.addEventListener("input", applyFilter);
filter.addEventListener("change", applyFilter);
city.addEventListener("change", loadData);

/* init */
loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
