
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å°åŒ— YouBike å³æ™‚åœ°åœ–</title>

https://unpkg.com/leaflet@1.9.4/dist/leaflet.css

<style>
  body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont; }
  #search {
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    z-index: 1000; padding: 8px 12px; width: 260px; font-size: 16px;
    border-radius: 8px; border: 1px solid #ccc; outline: none;
    box-shadow: 0 2px 6px rgba(0,0,0,.15); background: #fff;
  }
  #map { height: 100vh; width: 100%; }
  .circle {
    width: 52px; height: 52px; border-radius: 50%;
    color: white; text-align: center; font-size: 12px; line-height: 1.1;
    padding-top: 6px; box-sizing: border-box; font-weight: bold;
    border: 2px solid #fff; box-shadow: 0 0 4px rgba(0,0,0,.4);
  }
  .green { background: #2ecc71; }
  .yellow { background: #f1c40f; color: #333; }
  .red { background: #e74c3c; }
  .divider { border-top: 1px solid rgba(255,255,255,.6); margin: 2px 6px; }
</style>
</head>

<body>
<input id="search" placeholder="æœå°‹å ´ç«™åç¨±â€¦" />
<div id="map"></div>

<!-- æ­£ç¢ºå¼•å…¥ Leaflet JSï¼šä¸€å®šè¦ç”¨ <script src=...></script> -->
<script/unpkg.com/leaflet@1.9.4/dist/leaflet.js</script>

<script>
const API = "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";

const map = L.map("map").setView([25.04, 121.53], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let markers = [];
let rawData = [];

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function getColor(avail, empty) {
  if (avail === 0) return "yellow"; // æ²’è»Šå¯å€Ÿ
  if (empty === 0) return "red";    // æ²’ç©ºä½å¯é‚„
  return "green";
}

function render(list) {
  clearMarkers();

  const bounds = [];
  list.forEach(s => {
    const lat = Number(s.lat);
    const lng = Number(s.lng);
    if (isNaN(lat) || isNaN(lng)) return;

    const available = Number(s.sbi);   // å¯å€Ÿ
    const empty     = Number(s.bemp);  // å¯é‚„
    const total     = Number(s.tot);   // è»ŠæŸ±ç¸½æ•¸

    const icon = L.divIcon({
      className: "",
      html: `
        <div class="circle ${getColor(available, empty)}">
          å€Ÿ ${available}
          <div class="divider"></div>
          é‚„ ${empty}
        </div>
      `,
      iconSize: [52, 52]
    });

    const marker = L.marker([lat, lng], { icon }).addTo(map);
    marker.bindPopup(`
      <b>${s.sna}</b><br>
      ğŸš² å¯å€Ÿï¼š${available}<br>
      ğŸ…¿ï¸ å¯é‚„ï¼š${empty}<br>
      ğŸ“ è»ŠæŸ±ç¸½æ•¸ï¼š${total}
    `);

    markers.push(marker);
    bounds.push([lat, lng]);
  });

  // ç¬¬ä¸€æ¬¡è¼‰å…¥è‡ªå‹•ç¸®æ”¾åˆ°æ‰€æœ‰ç«™é»
  if (bounds.length && !render._fitted) {
    map.fitBounds(bounds, { padding: [40, 40] });
    render._fitted = true;
  }
}

async function loadData() {
  try {
    const res = await fetch(API, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    rawData = data;
    render(rawData);
  } catch (e) {
    console.error("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ˆAPIï¼‰", e);
    alert("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ˆAPIï¼‰");
  }
}

document.getElementById("search").addEventListener("input", e => {
  const keyword = e.target.value.trim();
  render(
    rawData.filter(s => s.sna && s.sna.includes(keyword))
  );
});

loadData();
setInterval(loadData, 30000);
</script>
</body>
</html>
