<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å°åŒ— YouBike å³æ™‚åœ°åœ–</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#map {
  width: 100%;
  height: 100%;
}

.top-bar {
  position: absolute;
  top: 12px;
  left: 60px;
  z-index: 1000;
  background: #fff;
  padding: 6px 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
}

.yb-circle {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  color: #fff;
  font-weight: bold;
  font-size: 13px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  line-height: 1.1;
  border: 2px solid #fff;
  box-shadow: 0 0 4px rgba(0,0,0,.4);
}

.green  { background: #7AC943; }
.yellow { background: #F5A623; }
.red    { background: #A80000; }

.line {
  font-size: 15px;
}
</style>
</head>

<body>

<div class="top-bar">
  ç«™é»ï¼š
  <input id="search" placeholder="æœå°‹å ´ç«™åç¨±">
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API =
  "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";

const map = L.map("map").setView([25.04, 121.53], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap",
}).addTo(map);

let markers = [];
let dataCache = [];

/* è®Šè‰²è¦å‰‡ */
function getColor(borrow, ret) {
  if (ret === 0) return "red";
  if (borrow === 0) return "yellow";
  return "green";
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function render(data) {
  clearMarkers();

  data.forEach(s => {
    const lat = Number(s.latitude);
    const lng = Number(s.longitude);
    const borrow = Number(s.available_rent_bikes);
    const ret    = Number(s.available_return_bikes);
    const total  = borrow + ret;

    // ğŸš§ é˜²å‘†ï¼šä»»ä½•ä¸€å€‹ä¸æ˜¯æ•¸å­—å°±è·³é
    if (
      Number.isNaN(lat) ||
      Number.isNaN(lng) ||
      Number.isNaN(borrow) ||
      Number.isNaN(ret)
    ) {
      return;
    }

    const icon = L.divIcon({
      className: "",
      iconSize: [50, 50],
      iconAnchor: [25, 25],
      html: `
        <div class="yb-circle ${getColor(borrow, ret)}">
          <div>${borrow}</div>
          <div class="line">â€”</div>
          <div>${ret}</div>
        </div>
      `,
    });

    const marker = L.marker([lat, lng], { icon })
      .addTo(map)
      .bindPopup(`
        <b>${s.sna}</b><br>
        ğŸš² å¯å€Ÿï¼š${borrow}<br>
        ğŸ…¿ï¸ å¯é‚„ï¼š${ret}<br>
        ğŸ“ ç¸½è»ŠæŸ±ï¼š${total}
      `);

    markers.push(marker);
  });
}

async function loadData() {
  try {
    const res = await fetch(API, { cache: "no-store" });
    const data = await res.json();
    dataCache = data;
    render(data);
  } catch (e) {
    console.error("è³‡æ–™è¼‰å…¥å¤±æ•—", e);
  }
}

document.getElementById("search").addEventListener("input", e => {
  const kw = e.target.value.trim();
  render(dataCache.filter(s => s.sna.includes(kw)));
});

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
