<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å°åŒ— YouBike å³æ™‚åœ°åœ–</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
  body { margin: 0; font-family: system-ui; }
  #map { height: 100vh; width: 100%; }

  .circle {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    color: white;
    text-align: center;
    font-size: 12px;
    line-height: 1.1;
    padding-top: 6px;
    box-sizing: border-box;
    font-weight: bold;
  }
  .green { background: #2ecc71; }
  .yellow { background: #f1c40f; color: #333; }
  .red { background: #e74c3c; }

  .divider {
    border-top: 1px solid rgba(255,255,255,.6);
    margin: 2px 6px;
  }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API =
  "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";

const map = L.map("map").setView([25.04, 121.53], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let markers = [];

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function getColor(avail, empty) {
  if (avail === 0) return "yellow";
  if (empty === 0) return "red";
  return "green";
}

async function loadData() {
  try {
    const res = await fetch(API, { cache: "no-store" });
    const data = await res.json();

    clearMarkers();

    data.forEach(s => {
      const lat = Number(s.lat);
      const lng = Number(s.lng);

      if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;

      const available = Number(s.available_rent_bikes);
      const empty = Number(s.available_return_bikes);
      const total = Number(s.total);

      const color = getColor(available, empty);

      const icon = L.divIcon({
        className: "",
        html: `
          <div class="circle ${color}">
            å€Ÿ ${available}
            <div class="divider"></div>
            é‚„ ${empty}
          </div>
        `,
        iconSize: [52, 52]
      });

      const marker = L.marker([lat, lng], { icon }).addTo(map);
      marker.bindPopup(`
        <b>${s.sna}</b><br>
        ğŸš² å¯å€Ÿï¼š${available}<br>
        ğŸ…¿ï¸ å¯é‚„ï¼š${empty}<br>
        ğŸ“ è»ŠæŸ±ç¸½æ•¸ï¼š${total}
      `);

      markers.push(marker);
    });

  } catch (e) {
    alert("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼ˆAPIï¼‰");
    console.error(e);
  }
}

loadData();
setInterval(loadData, 30000);
</script>
</body>
</html>
